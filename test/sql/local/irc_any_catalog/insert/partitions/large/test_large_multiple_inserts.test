# name: test/sql/local/irc/insert/partitions/large/test_large_multiple_inserts.test
# description: Test many sequential inserts into a partitioned table, populating the manifest list with many entries
# group: [large]

require-env ICEBERG_SERVER_AVAILABLE

require avro

require parquet

require iceberg

require httpfs

# Do not ignore 'HTTP' error messages!
set ignore_error_messages

statement ok
CREATE SECRET (
    TYPE S3,
    KEY_ID 'admin',
    SECRET 'password',
    ENDPOINT '127.0.0.1:9000',
    URL_STYLE 'path',
    USE_SSL 0
);

statement ok
ATTACH '' AS my_datalake (
    TYPE ICEBERG,
    CLIENT_ID 'admin',
    CLIENT_SECRET 'password',
    ENDPOINT 'http://127.0.0.1:8181'
);

statement ok
create schema if not exists my_datalake.default;

statement ok
drop table if exists my_datalake.default.test_large_multi_insert;

statement ok
CREATE TABLE my_datalake.default.test_large_multi_insert (id int, bucket int)
PARTITIONED BY (bucket);

# 10 separate inserts, each targeting a different bucket range
# This creates 10 manifest list entries

statement ok
insert into my_datalake.default.test_large_multi_insert select range, 0 from range(1000);

statement ok
insert into my_datalake.default.test_large_multi_insert select 1000 + range, 1 from range(1000);

statement ok
insert into my_datalake.default.test_large_multi_insert select 2000 + range, 2 from range(1000);

statement ok
insert into my_datalake.default.test_large_multi_insert select 3000 + range, 3 from range(1000);

statement ok
insert into my_datalake.default.test_large_multi_insert select 4000 + range, 4 from range(1000);

statement ok
insert into my_datalake.default.test_large_multi_insert select 5000 + range, 5 from range(1000);

statement ok
insert into my_datalake.default.test_large_multi_insert select 6000 + range, 6 from range(1000);

statement ok
insert into my_datalake.default.test_large_multi_insert select 7000 + range, 7 from range(1000);

statement ok
insert into my_datalake.default.test_large_multi_insert select 8000 + range, 8 from range(1000);

statement ok
insert into my_datalake.default.test_large_multi_insert select 9000 + range, 9 from range(1000);

# Total: 10 * 1000 = 10000
query I
select count(*) from my_datalake.default.test_large_multi_insert;
----
10000

# Now test manifest file skipping with logging
statement ok
CALL enable_logging('Iceberg');

statement ok
CALL truncate_duckdb_logs();

# Query bucket = 0 should skip 9 of 10 manifest files
query I
select count(*) from my_datalake.default.test_large_multi_insert where bucket = 0;
----
1000

query I
select count(*) from duckdb_logs() where type = 'Iceberg' and message like '%skipped%manifest_file%';
----
9

statement ok
CALL truncate_duckdb_logs();

# Query bucket = 5 should skip 9 of 10 manifest files
query I
select count(*) from my_datalake.default.test_large_multi_insert where bucket = 5;
----
1000

query I
select count(*) from duckdb_logs() where type = 'Iceberg' and message like '%skipped%manifest_file%';
----
9

statement ok
CALL truncate_duckdb_logs();

# Query bucket >= 8 should skip 8 of 10 manifest files (buckets 0-7)
query I
select count(*) from my_datalake.default.test_large_multi_insert where bucket >= 8;
----
2000

query I
select count(*) from duckdb_logs() where type = 'Iceberg' and message like '%skipped%manifest_file%';
----
8

statement ok
CALL truncate_duckdb_logs();

# No filter should skip 0 manifest files
query I
select count(*) from my_datalake.default.test_large_multi_insert;
----
10000

query I
select count(*) from duckdb_logs() where type = 'Iceberg' and message like '%skipped%manifest_file%';
----
0

# name: test/sql/local/iceberg_scans/test_bucket_predicate_pushdown.test
# description: Test bucket transform predicate pushdown
# group: [iceberg_scans]

require-env DUCKDB_ICEBERG_HAVE_GENERATED_DATA

require avro

require parquet

require iceberg

statement ok
attach ':memory:' as my_datalake;

statement ok
create schema my_datalake.default;

statement ok
create view my_datalake.default.partition_bucket_test as
select * from ICEBERG_SCAN('__WORKING_DIRECTORY__/data/persistent/partition_bucket_test');

# Enable logging to verify file filtering
statement ok
CALL enable_logging('Iceberg');

# Test 1: Verify total row count
query I
select count(*) from my_datalake.default.partition_bucket_test;
----
100

# Test 2: Query specific bucket data
statement ok
CALL truncate_duckdb_logs();

query I
select count(*) from my_datalake.default.partition_bucket_test
where partition_col = 'partition_0';
----
10

# Verify file filtering - should only scan files for bucket 0
# Check that manifest files were filtered by examining the logs
query I
SELECT COUNT(DISTINCT message)
FROM duckdb_logs()
WHERE type = 'Iceberg' AND message LIKE '%manifest_file%';
----
1

# Test 3: Query multiple buckets with IN clause
statement ok
CALL truncate_duckdb_logs();

query I
select count(*) from my_datalake.default.partition_bucket_test
where partition_col IN ('partition_0', 'partition_1', 'partition_2');
----
30

# Test 4: Verify query result correctness for a specific partition
query III
select id, name, partition_col
from my_datalake.default.partition_bucket_test
where partition_col = 'partition_5'
order by id;
----
5	user_5	partition_5
15	user_15	partition_5
25	user_25	partition_5
35	user_35	partition_5
45	user_45	partition_5
55	user_55	partition_5
65	user_65	partition_5
75	user_75	partition_5
85	user_85	partition_5
95	user_95	partition_5

# Test 5: Range query (should still work but may not filter as effectively)
query I
select count(*) from my_datalake.default.partition_bucket_test
where partition_col >= 'partition_3' AND partition_col <= 'partition_7';
----
50

# Test 6: Null handling
statement ok
CALL truncate_duckdb_logs();

# Should return 0 as we don't have null values in test data
query I
select count(*) from my_datalake.default.partition_bucket_test
where partition_col IS NULL;
----
0

# Test 7: Verify data distribution across all buckets
query II
SELECT partition_col, COUNT(*) as count
FROM my_datalake.default.partition_bucket_test
GROUP BY partition_col
ORDER BY partition_col;
----
partition_0	10
partition_1	10
partition_2	10
partition_3	10
partition_4	10
partition_5	10
partition_6	10
partition_7	10
partition_8	10
partition_9	10

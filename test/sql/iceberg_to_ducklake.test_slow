# name: test/sql/iceberg_to_ducklake.test_slow
# group: [sql]

require-env ICEBERG_SERVER_AVAILABLE

require avro

require parquet

require iceberg

require httpfs

require ducklake

# Do not ignore 'HTTP' error messages!
set ignore_error_messages

statement ok
set enable_logging=true

statement ok
set logging_level='debug'

statement ok
CREATE SECRET (
    TYPE S3,
    KEY_ID 'admin',
    SECRET 'password',
    ENDPOINT '127.0.0.1:9000',
    URL_STYLE 'path',
    USE_SSL 0
);


statement ok
ATTACH '' AS my_datalake (
    TYPE ICEBERG,
    CLIENT_ID 'admin',
    CLIENT_SECRET 'password',
    ENDPOINT 'http://127.0.0.1:8181'
);

statement ok
ATTACH 'ducklake:duckdb:__TEST_DIR__/ducklake.duckdb' as my_ducklake (DATA_PATH '__TEST_DIR__/data_path');

statement ok
call iceberg_to_ducklake(
    'my_datalake',
    'my_ducklake',
    skip_tables := [
        'pyspark_iceberg_table_v2',
        'deletion_vectors',
        'variant_column',
        'simple_v3_table'
    ]
)

# These are empty, so they are omitted:
# - insert_all_types
# - simple_v3_table
# - test_not_null
# - tpch

# These have an ALTER at the end, with no new snapshot added afterwards
# Without a snapshot, that means the change isn't recorded by the conversion
# So the results will not match
# - schema_evolve_struct_in_list
# - schema_evolve_struct_in_map

foreach table_name lineitem_partitioned_l_shipmode_deletes all_types_table day_timestamp day_timestamptz empty_insert filtering_on_bounds filtering_on_partition_bounds issue_328 lineitem_001_deletes lineitem_partitioned_l_shipmode lineitem_sf_01_1_delete lineitem_sf_01_no_deletes lineitem_sf1_deletes many_adds_deletes nested_types pyspark_iceberg_table_v1 quickstart_table schema_evolve_float_to_double schema_evolve_int_to_bigint schema_evolve_struct schema_evolve_widen_decimal table_more_deletes table_partitioned table_unpartitioned table_with_deletes year_timestamp year_timestamptz

query I rowsort expected_res
select * from my_datalake.default.${table_name}
----

query I rowsort expected_res
select * from my_ducklake.default.${table_name}
----

reset label expected_res

# table_name
endloop

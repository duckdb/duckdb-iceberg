# name: test/sql/cloud/test_snowflake_with_diff_permissions.test
# description: test integration with iceberg catalog read
# group: [cloud]

require-env ICEBERG_AWS_REMOTE_AVAILABLE

require-env SNOWFLAKE_CATALOG_URI_GCS

require-env SNOWFLAKE_SECRET_KEY_S3_PERMISSION_TEST

require-env SNOWFLAKE_KEY_ID_S3_PERMISSION_TEST

require avro

require parquet

require iceberg

require httpfs

require aws

# Do not ignore 'HTTP' error messages!
set ignore_error_messages

statement ok
create secret test_namespace_permissions (
    TYPE ICEBERG,
    CLIENT_ID '${SNOWFLAKE_KEY_ID_S3_PERMISSION_TEST}',
    CLIENT_SECRET '${SNOWFLAKE_SECRET_KEY_S3_PERMISSION_TEST}',
    ENDPOINT '${SNOWFLAKE_CATALOG_URI_GCS}'
);

statement ok
attach 's3-catalog' as my_datalake (
  	type ICEBERG,
  	default_region 'eu-west-2',
  	secret test_namespace_permissions,
  	ENDPOINT '${SNOWFLAKE_CATALOG_URI_GCS}',
  	support_nested_namespaces true
);

query I
select count(*) from (show all tables);
----
4
